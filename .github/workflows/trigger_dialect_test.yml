name: Run dialect tests

on:
  workflow_call:
    inputs:
      repo:
        required: true
        type: string
      artifact_url:
        required: true
        type: string
    secrets:
      pat:
        required: true

jobs:
  trigger_dialect_tests:
    runs-on: ubuntu-22.04
    env:
      REPO: ${{ inputs.REPO }}
      ARTIFACT_URL: ${{ inputs.ARTIFACT_URL }}
      PAT: ${{ secrets.PAT }}
    steps:
      - name: Trigger david8_changes workflow
        id: trigger
        run: |
          REF="main"
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "Dispatch timestamp: $TS"

          if [ -z "$ARTIFACT_URL" ]; then
            echo "Error: artifact_url is empty"
            exit 1
          fi

          RESPONSE=$(curl -s -o /tmp/response.json -w "%{http_code}" -X POST \
            -H "Authorization: token $PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$REPO/actions/workflows/david8_changes.yml/dispatches \
            -d "{\"ref\":\"$REF\", \"inputs\": {\"artifact_url\": \"$ARTIFACT_URL\", \"auth_token\": \"$PAT\"}}")

          HTTP_CODE=$(tail -n1 <<< "$RESPONSE")
          if [ "$HTTP_CODE" != "204" ]; then
            echo "Failed to trigger workflow: HTTP $HTTP_CODE"
            cat /tmp/response.json
            exit 1
          fi

          RUN_ID=""
          for i in {1..30}; do
            echo "Waiting for new RUN_ID, attempt $i/30..."
            sleep 3
      
            RUN_ID=$(curl -s \
              -H "Authorization: token $PAT" \
              "https://api.github.com/repos/$REPO/actions/workflows/david8_changes.yml/runs?event=workflow_dispatch&per_page=5" |
              jq -r --arg ts "$TS" '
                .workflow_runs
                | map(select(.created_at > $ts))
                | .[0].id // empty
              ')
      
            if [ -n "$RUN_ID" ]; then
              echo "FOUND new run: $RUN_ID"
              break
            fi
          done
      
          if [ -z "$RUN_ID" ]; then
            echo "ERROR: No new workflow run appeared after dispatch."
            exit 1
          fi
      
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Workflow https://github.com/$REPO/actions/runs/$RUN_ID started"

      - name: Wait for david8_changes workflow to complete
        id: wait_for_completion
        run: |
          RUN_ID="${{ steps.trigger.outputs.run_id }}"
          echo "Waiting for workflow: https://github.com/$REPO/actions/runs/$RUN_ID"

          STATUS="in_progress"
          CONCLUSION=""
          
          for i in {1..10}; do
            echo "Attempt $i/10..."
            sleep 3
          
            RUN_DATA=$(curl -s \
              -H "Authorization: token $PAT" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/actions/runs/$RUN_ID")
          
            STATUS=$(echo "$RUN_DATA" | jq -r '.status')
            CONCLUSION=$(echo "$RUN_DATA" | jq -r '.conclusion')
          
            echo "Current status: $STATUS, Workflow conclusion: $CONCLUSION"
          
            if [ "$STATUS" != "queued" ] && [ "$STATUS" != "in_progress" ] && [ "$STATUS" != "waiting" ]; then
              break
            fi
          done
          
          if [ "$CONCLUSION" != "success" ]; then
            echo "$REPO failed: $CONCLUSION"
            exit 1
          fi

          HTML_URL=$(echo "$RUN_DATA" | jq -r '.html_url')
          echo "Workflow completed successfully: $HTML_URL"
